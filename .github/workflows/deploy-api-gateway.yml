name: Deploy API Gateway to EC2

on:
  push:
    branches: [main]
    paths:
      - 'gateway/**'
      - '.github/workflows/deploy-api-gateway.yml'
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/api.hohyun.com
  DOCKER_TAG: v1

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        continue-on-error: true
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          script_stop: true
          sync: false
          debug: true
          use_insecure_cipher: false
          proxy_host: ""
          proxy_port: 0
          script: |
            set -e  # Exit on error

            echo "=== Starting API Gateway Docker Deployment ==="

            DOCKER_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/api.hohyun.com:v1"
            CONTAINER_NAME="api-gateway"

            # Docker 설치 확인
            if ! command -v docker &> /dev/null; then
              echo "Installing Docker..."
              sudo apt-get update -y && sudo apt-get install -y docker.io
              sudo systemctl start docker && sudo systemctl enable docker
            fi
            
            # Docker 서비스 확인
            sudo systemctl is-active docker || sudo systemctl start docker
            echo "Docker ready: $(sudo docker --version)"

            # Docker Hub 로그인 (sudo 사용)
            echo "Logging in to Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || true

            # 기존 컨테이너 중지 및 제거
            echo "Stopping existing container..."
            if sudo docker ps -a | grep -q $CONTAINER_NAME; then
              echo "Found existing container, stopping and removing..."
              sudo docker stop $CONTAINER_NAME 2>/dev/null || true
              sudo docker rm $CONTAINER_NAME 2>/dev/null || true
              echo "Existing container removed"
            else
              echo "No existing container found"
            fi

            # 최신 이미지 pull
            echo "Pulling latest image: $DOCKER_IMAGE"
            sudo docker pull $DOCKER_IMAGE

            # 환경 변수 파일 생성
            echo "Creating .env file..."
            {
              echo "SPRING_PROFILES_ACTIVE=production"
              echo "SPRING_DATASOURCE_URL=${{ secrets.NEON_CONNECTION_STRING }}"
              echo "SPRING_DATASOURCE_USERNAME=${{ secrets.NEON_USER }}"
              echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.NEON_PASSWORD }}"
              echo "SPRING_DATA_REDIS_HOST=${{ secrets.UPSTASH_REDIS_HOST }}"
              echo "SPRING_DATA_REDIS_PORT=${{ secrets.UPSTASH_REDIS_PORT }}"
              echo "SPRING_DATA_REDIS_PASSWORD=${{ secrets.UPSTASH_REDIS_PASSWORD }}"
              echo "JWT_SECRET=${{ secrets.JWT_SECRET }}"
              echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
              echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
              echo "GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}"
              echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}"
              echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}"
              echo "NAVER_REDIRECT_URI=${{ secrets.NAVER_REDIRECT_URI }}"
              echo "KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}"
              echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}"
              echo "KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}"
              echo "AI_SERVICE_RAG_URL=${{ secrets.AI_SERVICE_RAG_URL }}"
              echo "AI_SERVICE_VISION_URL=${{ secrets.AI_SERVICE_VISION_URL }}"
            } > ~/.env.api-gateway

            # Docker 컨테이너 실행
            echo "Starting Docker container..."
            if sudo docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file ~/.env.api-gateway \
              $DOCKER_IMAGE; then
              echo "✅ Container started successfully"
              CONTAINER_ID=$(sudo docker ps -q -f name=$CONTAINER_NAME)
              echo "Container ID: $CONTAINER_ID"
            else
              echo "❌ Failed to start container"
              echo "Checking for errors..."
              sudo docker ps -a | grep $CONTAINER_NAME || true
              sudo docker logs $CONTAINER_NAME 2>&1 | tail -20 || true
              exit 1
            fi

            # 컨테이너 상태 확인
            sleep 3
            if ! sudo docker ps | grep -q $CONTAINER_NAME; then
              echo "❌ Container failed to start!"
              sudo docker logs --tail 30 $CONTAINER_NAME
              exit 1
            fi
            
            echo "✅ Container is running"
            
            # 빠른 헬스 체크 (타임아웃 2초)
            curl -s -f -m 2 http://localhost:8080/actuator/health >/dev/null 2>&1 && echo "✅ Health check passed" || echo "⚠️  Health check pending"
            
            echo "✅ Deployment Complete"
            # 배포 성공 마커 파일 생성 (나중에 확인용)
            echo "DEPLOYMENT_SUCCESS=$(date +%s)" > /tmp/deployment_status.txt || true

      - name: Verify Deployment via Health Check
        if: always()
        run: |
          echo "Checking if deployment actually succeeded..."
          sleep 10
          
          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i/$MAX_RETRIES..."
            code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 http://${{ secrets.EC2_HOST }}:8080/actuator/health 2>/dev/null || echo "000")
            
            if [ "$code" = "200" ]; then
              echo "✅ Deployment verified: Service is healthy!"
              exit 0
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              sleep 5
            fi
          done
          
          if [ "${{ steps.deploy.outcome }}" = "failure" ]; then
            echo "⚠️  SSH connection failed, but service may still be running"
            echo "Please verify manually: ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'docker ps | grep api-gateway'"
          else
            echo "⚠️  Deployment completed but health check failed"
            echo "Service may need more time to start. Check logs:"
            echo "ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'docker logs api-gateway'"
          fi



