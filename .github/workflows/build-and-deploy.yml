name: Build & Deploy API Gateway

on:
  push:
    branches: [main]
    paths:
      - 'gateway/**'
      - '.github/workflows/build-and-deploy.yml'
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/api.hohyun.com
  DOCKER_TAG: v1

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ env.DOCKER_TAG }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./gateway/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Deploy to EC2
        continue-on-error: true
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          script_stop: true
          sync: false
          debug: true
          use_insecure_cipher: false
          proxy_host: ""
          proxy_port: 0
          script: |
            set -e  # Exit on error

            echo "=== Starting API Gateway Docker Deployment ==="

            DOCKER_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/api.hohyun.com:${{ env.DOCKER_TAG }}"
            CONTAINER_NAME="api-gateway"

            # Docker 설치 및 확인
            echo "=== Checking Docker Installation ==="
            if ! command -v docker &> /dev/null && ! sudo command -v docker &> /dev/null; then
              echo "Docker not found. Installing Docker..."
              sudo apt-get update -y
              sudo apt-get install -y docker.io
              sudo systemctl start docker
              sudo systemctl enable docker
              
              # Docker 설치 확인
              if ! sudo docker --version &> /dev/null; then
                echo "❌ Docker installation failed!"
                exit 1
              fi
              
              echo "✅ Docker installed successfully"
            else
              echo "Docker is already installed"
            fi
            
            # Docker 서비스 확인 및 시작
            if ! sudo systemctl is-active --quiet docker; then
              echo "Starting Docker service..."
              sudo systemctl start docker
              sleep 2
            fi
            
            # Docker 서비스 상태 확인
            if ! sudo systemctl is-active --quiet docker; then
              echo "❌ Docker service failed to start!"
              sudo systemctl status docker --no-pager || true
              exit 1
            fi
            
            # Docker 명령어 테스트
            DOCKER_VERSION=$(sudo docker --version 2>&1)
            if [ $? -ne 0 ]; then
              echo "❌ Docker command failed: $DOCKER_VERSION"
              exit 1
            fi
            
            echo "✅ Docker ready: $DOCKER_VERSION"
            echo "Docker service status: $(sudo systemctl is-active docker)"

            # Docker Hub 로그인 (sudo 사용)
            echo "Logging in to Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | sudo docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin || true

            # 기존 컨테이너 중지 및 제거
            echo "Stopping existing container..."
            if sudo docker ps -a | grep -q $CONTAINER_NAME; then
              echo "Found existing container, stopping and removing..."
              sudo docker stop $CONTAINER_NAME 2>/dev/null || true
              sudo docker rm $CONTAINER_NAME 2>/dev/null || true
              echo "Existing container removed"
            else
              echo "No existing container found"
            fi

            # 최신 이미지 pull
            echo "Pulling latest image: $DOCKER_IMAGE"
            sudo docker pull $DOCKER_IMAGE

            # 환경 변수 파일 생성
            echo "Creating .env file..."
            {
              echo "SPRING_PROFILES_ACTIVE=production"
              echo "SPRING_DATASOURCE_URL=${{ secrets.NEON_CONNECTION_STRING }}"
              echo "SPRING_DATASOURCE_USERNAME=${{ secrets.NEON_USER }}"
              echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.NEON_PASSWORD }}"
              echo "SPRING_DATA_REDIS_HOST=${{ secrets.UPSTASH_REDIS_HOST }}"
              echo "SPRING_DATA_REDIS_PORT=${{ secrets.UPSTASH_REDIS_PORT }}"
              echo "SPRING_DATA_REDIS_PASSWORD=${{ secrets.UPSTASH_REDIS_PASSWORD }}"
              echo "JWT_SECRET=${{ secrets.JWT_SECRET }}"
              echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
              echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
              echo "GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}"
              echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}"
              echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}"
              echo "NAVER_REDIRECT_URI=${{ secrets.NAVER_REDIRECT_URI }}"
              echo "KAKAO_REST_API_KEY=${{ secrets.KAKAO_REST_API_KEY }}"
              echo "KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}"
              echo "KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}"
              echo "AI_SERVICE_RAG_URL=${{ secrets.AI_SERVICE_RAG_URL }}"
              echo "AI_SERVICE_VISION_URL=${{ secrets.AI_SERVICE_VISION_URL }}"
            } > ~/.env.api-gateway

            # Docker 컨테이너 실행
            echo "Starting Docker container..."
            if sudo docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p 8080:8080 \
              --env-file ~/.env.api-gateway \
              $DOCKER_IMAGE; then
              echo "✅ Container started successfully"
              CONTAINER_ID=$(sudo docker ps -q -f name=$CONTAINER_NAME)
              echo "Container ID: $CONTAINER_ID"
            else
              echo "❌ Failed to start container"
              echo "Checking for errors..."
              sudo docker ps -a | grep $CONTAINER_NAME || true
              sudo docker logs $CONTAINER_NAME 2>&1 | tail -20 || true
              exit 1
            fi

            # 컨테이너 상태 확인
            echo "Waiting for container to initialize..."
            sleep 5
            
            if ! sudo docker ps | grep -q $CONTAINER_NAME; then
              echo "❌ Container failed to start!"
              echo "=== Container Status ==="
              sudo docker ps -a | grep $CONTAINER_NAME || true
              echo ""
              echo "=== Container Logs (last 50 lines) ==="
              sudo docker logs --tail 50 $CONTAINER_NAME || true
              exit 1
            fi
            
            echo "✅ Container is running"
            echo "=== Container Details ==="
            sudo docker ps | grep $CONTAINER_NAME
            echo ""
            
            # 컨테이너 로그 확인 (애플리케이션 시작 여부)
            echo "=== Recent Container Logs ==="
            sudo docker logs --tail 20 $CONTAINER_NAME || true
            echo ""
            
            # 애플리케이션 시작 대기 (최대 60초)
            echo "Waiting for application to start..."
            MAX_WAIT=60
            WAIT_INTERVAL=5
            ELAPSED=0
            APP_READY=false
            
            while [ $ELAPSED -lt $MAX_WAIT ]; do
              if curl -s -f -m 3 http://localhost:8080/actuator/health >/dev/null 2>&1; then
                echo "✅ Application is ready!"
                APP_READY=true
                break
              fi
              
              echo "⏳ Application starting... (${ELAPSED}s/${MAX_WAIT}s)"
              sleep $WAIT_INTERVAL
              ELAPSED=$((ELAPSED + WAIT_INTERVAL))
            done
            
            if [ "$APP_READY" = "false" ]; then
              echo "⚠️  Application did not become ready within ${MAX_WAIT}s"
              echo "=== Container Logs (last 50 lines) ==="
              sudo docker logs --tail 50 $CONTAINER_NAME || true
              echo ""
              echo "⚠️  Deployment completed but application may need more time"
            else
              # 최종 헬스 체크
              echo ""
              echo "=== Final Health Check ==="
              curl -s http://localhost:8080/actuator/health | head -20 || echo "Health check failed"
              echo ""
            fi
            
            echo "✅ Deployment Complete"
            # 배포 성공 마커 파일 생성 (나중에 확인용)
            echo "DEPLOYMENT_SUCCESS=$(date +%s)" > /tmp/deployment_status.txt || true

      - name: Verify Deployment via Health Check
        if: always()
        run: |
          echo "Checking if deployment actually succeeded..."
          sleep 15
          
          MAX_RETRIES=10
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i/$MAX_RETRIES..."
            code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 --max-time 10 http://${{ secrets.EC2_HOST }}:8080/actuator/health 2>/dev/null || echo "000")
            
            if [ "$code" = "200" ]; then
              echo "✅ Deployment verified: Service is healthy!"
              echo ""
              echo "=== Service URLs ==="
              echo "Health: http://${{ secrets.EC2_HOST }}:8080/actuator/health"
              echo "Docs: http://${{ secrets.EC2_HOST }}:8080/docs"
              exit 0
            fi
            
            echo "Response code: $code"
            if [ $i -lt $MAX_RETRIES ]; then
              sleep 5
            fi
          done
          
          echo ""
          echo "⚠️  External health check failed"
          echo ""
          echo "=== Troubleshooting Steps ==="
          echo "1. Check if container is running:"
          echo "   ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'sudo docker ps | grep api-gateway'"
          echo ""
          echo "2. Check container logs:"
          echo "   ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'sudo docker logs api-gateway --tail 50'"
          echo ""
          echo "3. Check if port is listening:"
          echo "   ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'sudo ss -tulpn | grep :8080'"
          echo ""
          echo "4. Check security group:"
          echo "   - Ensure port 8080 is open for 0.0.0.0/0 (or your IP)"
          echo "   - AWS Console > EC2 > Security Groups"
          echo ""
          if [ "${{ steps.deploy.outcome }}" = "failure" ]; then
            echo "5. SSH connection had issues, but deployment may have succeeded"
          fi

